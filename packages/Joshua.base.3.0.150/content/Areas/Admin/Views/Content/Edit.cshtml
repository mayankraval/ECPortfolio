@using Joshua.Models
@model Joshua.Models.Content
@{
  ViewBag.Title = "Edit content";
  Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
  var contenttype = J.ContentTypes.InstalledContentTypes.Where(c => c.Name == Model.ContentType).FirstOrDefault();
}

<h2 class="controls">Edit Content</h2>

@using (Html.BeginForm("Save", "Content", new { area = "Admin", returnurl = this.Request.QueryString["returnurl"] }, FormMethod.Post, new { enctype = "multipart/form-data", @class = "form-horizontal", id = "create_new_content_form" }))
{
  <div class="span9">
    @Html.ValidationSummary(true)
    @Html.HiddenFor(model => model._Id)
    @Html.HiddenFor(model => model.ImageUri)
    @Html.HiddenFor(model => model.ContentType)
    @Html.HiddenFor(model => model.OrderIndex)

    <fieldset>
      <legend></legend>
      <style>
        .control-label, .controls {
          text-align: left;
        }

        span[rel="popover"] {
          cursor: pointer;
        }
      </style>

      <div class="control-group" style="display:@(J.Settings["joshua:admin:showcontentname"] == "true" ? "block" : "none")">
        @Html.LabelFor(model => model.Name, new { @class = "control-label" })
        <div class="controls">
          @Html.EditorFor(model => model.Name)
          <span data-placement="right" data-original-title="what is this?"
            data-content="Name property is used to access directly to this content via code. Are you an user ? Ignore it."
            rel="popover">
            <i class="icon-exclamation-sign"></i>
          </span>

          @Html.ValidationMessageFor(model => model.Name)
        </div>
      </div>

      <div class="control-group" style="display:@(J.Settings["joshua:admin:showcontentpath"] == "true" ? "block" : "none")">
        @Html.LabelFor(model => model.Path, new { @class = "control-label" })

        <div class="controls">
          @Html.TextBoxFor(model => model.Path, new { style = "width:50%;" })
          <span data-placement="right" data-original-title="what is this?"
            data-content="Path property is used to access this content via Url. You can change it to a more comprehensive value."
            rel="popover">
            <i class="icon-exclamation-sign"></i>
          </span>

          @Html.ValidationMessageFor(model => model.Path)
        </div>
      </div>

      <div class="control-group">
        @Html.LabelFor(model => model.Title, new { @class = "control-label" })

        <div class="controls">
          @Html.TextBoxFor(model => model.Title, new { style = "width:80%;" })
          @Html.ValidationMessageFor(model => model.Title)
        </div>
      </div>

      <div class="control-group">
        @Html.LabelFor(model => model.ExternalLink, new { @class = "control-label" })

        <div class="controls">
          @Html.TextBoxFor(model => model.ExternalLink, new { style = "width:80%;" })
          @Html.ValidationMessageFor(model => model.ExternalLink)
        </div>
      </div>

      <div class="tabbable">
        <ul class="nav nav-tabs">
          <li @MvcHtmlString.Create(contenttype == null || string.IsNullOrEmpty(contenttype.DefaultAdministrationTab) ? "class=\"active\"" : "")>
            <a href="#tab1" data-toggle="tab">Body</a></li>
          <li><a href="#tab2" data-toggle="tab">Abstract</a></li>
          <li><a href="#tab3" data-toggle="tab">Post Image</a></li>
          @{ var index = 4;
             foreach (var r in J.Plugins.GetAdminRenderers(Joshua.Helpers.PageOperationEnum.Edit, contenttype != null ? contenttype.Plugins.ToArray() : null))
             {
            <li @MvcHtmlString.Create(contenttype != null && contenttype.DefaultAdministrationTab == r.Key ? "class=\"active\"" : "")>
              <a href="#tab@(index++)" data-toggle="tab">@r.Key</a></li>
             }
          }
        </ul>
        <div class="tab-content">
          <div class="tab-pane @(contenttype == null || string.IsNullOrEmpty(contenttype.DefaultAdministrationTab) ? "active" : "")" id="tab1">
            @if (!string.IsNullOrEmpty(J.Settings["joshua:fontformattingcss"]))
            { 
              <link href="@J.Settings["joshua:fontformattingcss"]" type="text/css" rel="stylesheet" />
            }
            <div class="editablebody" data-mercury="full" data-hiddenfield="Body" style="width: 98%;">
              @MvcHtmlString.Create(Model != null ? Model.Body : "Your content here")
            </div>
            @Html.HiddenFor(model => model.Body)
            @Html.ValidationMessageFor(model => model.Body)
          </div>
          <div class="tab-pane" id="tab2">
            @Html.TextAreaFor(model => model.Abstract, new { style = "width:98%;", rows = 10 })
            @Html.ValidationMessageFor(model => model.Abstract)
          </div>
          <div class="tab-pane" id="tab3">

            <div class="form-inline">
              @Html.LabelFor(model => model.ImageWidth)
              @Html.TextBoxFor(model => model.ImageWidth, new { @class = "input-small" })

              @Html.LabelFor(model => model.ImageHeight)
              @Html.TextBoxFor(model => model.ImageHeight, new { @class = "input-small" })
            </div>
            <a onclick="javascript:RemoveImage()" class="btn btn-danger pull-right"><i class="icon-trash icon-white"></i></a>

            <div class="form-inline" style="margin: 10px;">
              <label>Current Image :</label>
              <label id="_imagename">@Model.GetImageUri()</label>
            </div>
            <div class="control-group">
              <div class="controls">
                @if (!string.IsNullOrEmpty(Model.ImageUri))
                {
                  <img id="_postimage" src="@Model.GetImageUri()" class="span5" />
                }
              </div>
            </div>
            <div class="control-group">
              <label class="control-label">Upload a new image</label>
              <div class="controls">
                @Html.UploadFor(model => model.File)
              </div>
            </div>
          </div>
          @{var index2 = 4;
            foreach (var r in J.Plugins.GetAdminRenderers(Joshua.Helpers.PageOperationEnum.Edit, contenttype != null ? contenttype.Plugins.ToArray() : null))
            { 
            <div class="tab-pane @(contenttype != null && contenttype.DefaultAdministrationTab == r.Key ? "active" : "")" id="tab@(index2++)">
              @r.Value(this.Html, this.Model._Id, Joshua.Helpers.PageOperationEnum.Edit)
            </div>
            }
          }
        </div>
      </div>

    </fieldset>
  </div>
  
  <div class="span3">
    <div class="navbar-inner" style="min-height: 300px;">

      <h3>Status</h3>
      <label class="checkbox">
        @Html.CheckBoxFor(model => model.Published)
        Published
      </label>
      <hr />

      <h3>Containers</h3>
      @{ViewBag.SelectedContainers = Model.Containers;}
      @Html.Partial("_part_Containers", J.Data.Containers().Get((Container c) => c.ParentId == null && c.Language == UICulture).ToList())

      <hr />

    </div>
    <div class="btn-group" style="margin-top: 10px;">
      <button class="btn btn-primary btn-large" onclick="javascript:$('#create_new_content_form').submit()"><i class="icon-ok icon-white"></i>&nbsp;Save</button>
      <a href="/Admin/Content/Index/" class="btn btn-large"><i class="icon-arrow-left"></i>&nbsp;Cancel</a>
    </div>
  </div>
}

@section Scripts {
  @Scripts.Render("~/bundles/jqueryval")
  @Html.Partial("Partial_Mercury")
  <script type="text/javascript">
    $(function () {
      $('[rel="popover"]').popover();
    });

    function RemoveImage() {
      $('#_postimage').each(function () { $(this).detach(); });
      $('#_imagename').each(function () { $(this).detach(); });
      $('#ImageUri').each(function () { $(this).val(""); });
    }
  </script>
}
