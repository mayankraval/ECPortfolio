@model IEnumerable<Joshua.Models.Content>
@{
  ViewBag.Title = "Contents";
  Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}
@Html.Part_Alert()
<div class="container">
  <h2>
    @if (ViewBag.Container != null)
    { 
      <text>Content for: @(ViewBag.Container.Description)</text>
    }
    else
    { 
      <text>All Contents</text>
    }
  </h2>

  <div class="row">
    <div class="btn-group span1">
      <a class="btn dropdown-toggle btn-primary" data-toggle="dropdown" href="#">
        <i class="icon-plus icon-white"></i>&nbsp; Add new content
      @*<span class="caret"></span>*@
      </a>
      <ul class="dropdown-menu">
        @foreach (var ct in J.ContentTypes.InstalledContentTypes)
        { 
          <li><a href="javascript:navigate('/Admin/Content/Create?contenttype=@ct.Name&returnurl=' + window.location)">@ct.FriendlyName</a></li>
        }
      </ul>
    </div>
    <label class="span1 offset3" style="margin-top: 5px;">Order by</label>
    <form class="span1" method="get">
      <input type="hidden" value="@(ViewBag.SearchInfo ?? "")" name="search" />
      <select id="orderby-combo" name="orderby">
        <option value="date" @(ViewBag.OrderInfo == "date" ? "selected" : "")>Date</option>
        <option value="date-desc" @(ViewBag.OrderInfo == "date-desc" ? "selected" : "")>Date Descending</option>
        @if (J.Settings["joshua:admin:useorderindexsorting"] == "true")
        {
          <option value="index" @(ViewBag.OrderInfo == "index" ? "selected" : "")>Index</option>
          <option value="index-desc" @(ViewBag.OrderInfo == "index-desc" ? "selected" : "")>Index Descending</option>
        }
      </select>
    </form>
    <form class="form-search span4 pull-right" method="get">
      <div class="input-append">
        <input type="hidden" name="orderby" value="@ViewBag.OrderInfo" />
        <input type="text" name="search" class="input-large search-query ">
        <button type="submit" class="btn">Search</button>
      </div>
    </form>
  </div>
  <div class="row">
    <table class="table table-stripped table-hover">
      <thead>
        <tr>
          <th>
            @Html.DisplayNameFor(model => model.Name)
          </th>
          <th>
            @Html.DisplayNameFor(model => model.Title)
          </th>
          @if (J.Settings["joshua:admin:showcontentpath"] == "true")
          {
            <th>
              @Html.DisplayNameFor(model => model.Path)
            </th>
          }
          <th>
            @Html.DisplayNameFor(model => model.Published)
          </th>
          <th>
            @Html.DisplayNameFor(model => model.ContentType)
          </th>
          <th style="width: 1%;"></th>
          <th style="width: 10%;"></th>
        </tr>
      </thead>
      <tbody class="sortable">
        @if (Model != null)
        {
          foreach (var item in Model)
          {
          <tr data-id="@item._Id" data-orderindex="@item.OrderIndex">
            <td>
              @Html.DisplayFor(modelItem => item.Name)
            </td>
            <td>
              @Html.DisplayFor(modelItem => item.Title)
            </td>
            @if (J.Settings["joshua:admin:showcontentpath"] == "true")
            {
              <td>
                @Html.DisplayFor(modelItem => item.Path)
              </td>
            }
            <td>
              @Html.DisplayFor(modelItem => item.Published)
            </td>
            <td>
              @Html.DisplayFor(modelItem => item.ContentType)
            </td>
            <td>
              @if (J.Settings["joshua:admin:useorderindexsorting"] == "true" && (ViewBag.OrderInfo == "index" || ViewBag.OrderInfo == "index-desc"))
              {
                <div class="btn sorter" style="cursor: move"><i class="icon-resize-vertical"></i></div>
              }
            </td>
            <td>
              <div class="btn-group">
                <button class="btn btn-warning" onclick="javascript:navigate('/Admin/content/Edit/@(item._Id)?returnurl=' + window.location)"><i class="icon-pencil "></i></button>
                <button class="btn btn-danger" onclick="javascript:deleteItem('/Admin/content','@item._Id')"><i class="icon-trash icon-white"></i></button>
              </div>
            </td>
          </tr>
          }
        }
      </tbody>
    </table>
  </div>
  <div class="row">
    @Html.Partial("Partial_Paginator")
  </div>
</div>


@section scripts
{
  <script type="text/javascript">
  @if (Model != null)
  {
    var originalorder = Newtonsoft.Json.JsonConvert.SerializeObject(Model.Select(m => m.OrderIndex));
    <text>
    var originalorder = "@(originalorder)";
    </text>
  }
  </script>
  <script type="text/javascript">

    function deleteItem(controller, itemid) {
      ShowModal("Warning", "the selected content will be deleted", function () {
        $.get(controller + "/Delete/" + itemid, null, function (data) {
          if (Boolean(data)) {
            $("[data-id=\"" + itemid + "\"]").remove();
            ShowAlert("The content has been deleted ");
          }
          else {
            ShowAlert(data);
          }
        });
      });
    }

    function enablesorting() {
      // mantiene fissa la dimensione delle colonne. 
      // in modo che al riga on venga collassata durante il drag&drop
      var fixwidthhelper = function (e, ui) {
        ui.children().each(function () {
          $(this).width($(this).width());
        });
        return ui;
      };

      var showsortresult = function (result) {
        if (Boolean(result))
          ShowAlert("Contents has been re-sorted")
      }

      var applysorting = function (e, ui) {
        var newidlist = "[\"";
        $(".sortable").find("tr").each(function () {
          newidlist += $(this).attr("data-id") + "\",\"";
        });
        newidlist += "\"]";

        $.ajax({
          type: "POST",
          url: "/Admin/Content/Sort",
          success: showsortresult,
          data: { ids: newidlist, order: originalorder },
          dataType: "json",
          xhrFields: {
            withCredentials: true
          }
        });
      };

      $(".sortable").on("sortupdate", applysorting);
      $(".sortable").sortable({ handle: ".sorter", helper: fixwidthhelper }).disableSelection();
    }

    $(function () {
      $("#orderby-combo").on("change", function () { $("form").has($(this)).submit(); });
    });

    @if (J.Settings["joshua:admin:useorderindexsorting"] == "true")
    { 
    <text>
    $(enablesorting())
    </text>
    }
  </script>
}
